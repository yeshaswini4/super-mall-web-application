<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist - SuperMall</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="static/css/main.css">
    <style>
        .wishlist-container { max-width: 1200px; margin: 100px auto 40px; padding: 20px; }
        .wishlist-item { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; align-items: center; gap: 20px; }
        .wishlist-item img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; }
        .wishlist-item-info { flex: 1; }
        .wishlist-item h3 { margin: 0 0 5px; font-size: 1.2rem; }
        .wishlist-item .price { font-size: 1.5rem; font-weight: 700; color: #667eea; }
        .btn-remove { background: #f56565; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        .btn-add-cart { background: #48bb78; color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        .empty-wishlist { text-align: center; padding: 60px 20px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-left"><span class="logo-text">üõí SuperMall</span></div>
        <div class="nav-right">
            <a href="index.html">Home</a>
            <a href="shop_list.html">Shops</a>
            <a href="offers.html">Offers</a>
            <a href="compare.html">Compare</a>
            <a href="wishlist.html" style="position:relative;">‚ù§Ô∏è Wishlist <span id="wishlistBadge" style="position:absolute;top:-5px;right:-10px;background:#e53e3e;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;display:none;align-items:center;justify-content:center;">0</span></a>
            <a href="cart.html" style="position:relative;">üõí Cart <span id="cartBadge" style="position:absolute;top:-5px;right:-10px;background:#e53e3e;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;display:none;align-items:center;justify-content:center;">0</span></a>
            <div id="userMenu" style="position:relative;display:none;">
                <button id="profileBtn" style="background:#667eea;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;"></button>
            </div>
            <a href="login.html" id="loginBtn" class="btn-primary">Login</a>
        </div>
    </nav>

    <div class="wishlist-container">
        <h1>‚ù§Ô∏è My Wishlist</h1>
        <div id="wishlistItems"></div>
    </div>

    <footer class="footer"><p>¬© 2025 SuperMall</p></footer>

    <script src="static/js/config.js"></script>
    <script src="static/js/auth.js"></script>
    <script src="static/js/enhanced-cart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Get user info and display properly
            await authService.init();
            const user = authService.getCurrentUser();
            
            // Force show user menu and hide login button
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('userMenu').style.display = 'block';
            document.getElementById('profileBtn').textContent = user?.username || 'User';
            
            // Try to load wishlist directly from API
            try {
                const response = await fetch('http://127.0.0.1:8000/api/wishlist/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Wishlist API response status:', response.status);
                
                if (response.ok) {
                    const wishlist = await response.json();
                    console.log('Wishlist data:', wishlist);
                    console.log('Wishlist length:', wishlist.length);
                    displayWishlistItems(wishlist);
                } else {
                    console.log('Wishlist API failed with status:', response.status);
                    // Fallback: show items from localStorage
                    showLocalStorageWishlist();
                }
            } catch (error) {
                console.log('Wishlist error:', error);
                // Fallback: show items from localStorage
                showLocalStorageWishlist();
            }
        });
        
        function showLocalStorageWishlist() {
            // Check localStorage for any stored wishlist items
            const localStorageKeys = Object.keys(localStorage).filter(key => 
                key.startsWith('wishlist_product_')
            );
            console.log('LocalStorage wishlist keys:', localStorageKeys);
            
            if (localStorageKeys.length > 0) {
                const wishlistItems = document.getElementById('wishlistItems');
                const items = localStorageKeys.map((key, index) => {
                    try {
                        const productDetails = JSON.parse(localStorage.getItem(key));
                        return `
                            <div class="wishlist-item">
                                <img src="${productDetails.image}" alt="${productDetails.name}">
                                <div class="wishlist-item-info">
                                    <h3>${productDetails.name}</h3>
                                    <p style="color: #718096;">${productDetails.shopName || productDetails.category}</p>
                                    <div class="price">‚Çπ${Math.round(productDetails.price * 83)}</div>
                                </div>
                                <div>
                                    <button class="btn-add-cart" onclick="addToCartFromLocal('${key}')">Add to Cart</button>
                                    <button class="btn-remove" onclick="removeFromLocal('${key}')">Remove</button>
                                </div>
                            </div>
                        `;
                    } catch (e) {
                        return '';
                    }
                }).filter(item => item).join('');
                
                if (items) {
                    wishlistItems.innerHTML = items;
                } else {
                    showEmptyWishlist();
                }
            } else {
                showEmptyWishlist();
            }
        }
        
        function displayWishlistItems(wishlist) {
            const wishlistItems = document.getElementById('wishlistItems');
            
            if (wishlist.length === 0) {
                showEmptyWishlist();
                return;
            }
            
            wishlistItems.innerHTML = wishlist.map(item => {
                // Try to find stored product details
                let productDetails = null;
                const productId = item.product.id;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('wishlist_product_') && key.includes(`${productId}_`)) {
                        try {
                            productDetails = JSON.parse(localStorage.getItem(key));
                            break;
                        } catch (e) {}
                    }
                }
                
                const displayName = productDetails?.name || item.product.name;
                const displayPrice = productDetails?.price || item.product.price;
                const displayImage = productDetails?.image || item.product.image || 'https://images.unsplash.com/photo-1593359677879-a4bb92f829d1?w=400';
                const displayCategory = productDetails?.shopName || productDetails?.category || item.product.category || 'SuperMall';
                
                return `
                    <div class="wishlist-item">
                        <img src="${displayImage}" alt="${displayName}">
                        <div class="wishlist-item-info">
                            <h3>${displayName}</h3>
                            <p style="color: #718096;">${displayCategory}</p>
                            <div class="price">‚Çπ${Math.round(displayPrice * 83)}</div>
                        </div>
                        <div>
                            <button class="btn-add-cart" onclick="moveToCart(${item.id}, ${item.product.id})">Add to Cart</button>
                            <button class="btn-remove" onclick="removeFromWishlist(${item.id})">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showEmptyWishlist() {
            document.getElementById('wishlistItems').innerHTML = `
                <div class="empty-wishlist">
                    <h2>Your wishlist is empty</h2>
                    <p>Add some products to your wishlist</p>
                    <a href="shop_list.html" class="btn-primary">Browse Shops</a>
                </div>
            `;
        }
        
        function showLoginMessage() {
            document.getElementById('wishlistItems').innerHTML = `
                <div class="empty-wishlist">
                    <h2>Please login to view your wishlist</h2>
                    <p>Sign in to save and manage your favorite products</p>
                    <a href="login.html" class="btn-primary">Login Now</a>
                </div>
            `;
        }

        async function removeFromWishlist(wishlistId) {
            try {
                const response = await fetch(`http://127.0.0.1:8000/api/wishlist/${wishlistId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    location.reload(); // Reload page to refresh wishlist
                }
            } catch (error) {
                console.error('Remove failed:', error);
            }
        }

        async function moveToCart(wishlistId, productId) {
            try {
                // Add to cart
                await fetch('http://127.0.0.1:8000/api/cart/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ product_id: productId, quantity: 1 })
                });
                
                // Remove from wishlist
                await removeFromWishlist(wishlistId);
            } catch (error) {
                console.error('Move to cart failed:', error);
            }
        }
        
        function addToCartFromLocal(localKey) {
            try {
                const productDetails = JSON.parse(localStorage.getItem(localKey));
                // Add to cart using universal function
                addToCart(productDetails.name, productDetails.price * 83, productDetails.shopName, productDetails.category);
                // Remove from localStorage
                localStorage.removeItem(localKey);
                location.reload();
            } catch (error) {
                console.error('Add to cart from local failed:', error);
            }
        }
        
        function removeFromLocal(localKey) {
            localStorage.removeItem(localKey);
            location.reload();
        }
    </script>
</body>
</html>